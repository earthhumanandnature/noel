<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Quả Cầu Tuyết Giáng Sinh 2025</title>
  <style>
    body { margin:0; overflow:hidden; background:#0a1a3a; touch-action:none; }
    #info {
      position:absolute; top:20px; left:50%; transform:translateX(-50%);
      color:#fff; background:rgba(0,0,0,0.6); padding:12px 30px; border-radius:30px;
      font-family:'Segoe UI',Arial,sans-serif; font-size:17px; pointer-events:none; z-index:10;
    }
  </style>
</head>
<body>
  <div id="info">Chạm vào quả cầu tuyết để lắc nào!</div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a1a3a);

    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 350;

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.enablePan = false;
    controls.minDistance = 180;
    controls.maxDistance = 550;

    // ==================== QUẢ CẦU TUYẾT ====================
    const globe = new THREE.Group();
    scene.add(globe);

    // Kính ngoài (để raycast bắt click chính xác)
    const glass = new THREE.Mesh(
      new THREE.SphereGeometry(120, 64, 64),
      new THREE.MeshStandardMaterial({
        color: 0xffffff,
        metalness: 0.05,
        roughness: 0,
        transparent: true,
        opacity: 0.15,
        side: THREE.FrontSide
      })
    );
    globe.add(glass);

    // Đế gỗ
    const base = new THREE.Mesh(
      new THREE.CylinderGeometry(82, 92, 62, 64),
      new THREE.MeshStandardMaterial({ color: 0x8b4513 })
    );
    base.position.y = -150;
    globe.add(base);

    // Dải đỏ quanh đế
    const ribbon = new THREE.Mesh(
      new THREE.RingGeometry(80, 92, 64),
      new THREE.MeshStandardMaterial({ color: 0xc41e3a, side: THREE.DoubleSide })
    );
    ribbon.rotation.x = -Math.PI/2;
    ribbon.position.y = -125;
    globe.add(ribbon);

    // Nhãn Christmas
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 128;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createLinearGradient(0,0,512,128);
    grad.addColorStop(0,'#ffd700'); grad.addColorStop(1,'#b8860b');
    ctx.fillStyle = grad; ctx.fillRect(0,0,512,128);
    ctx.strokeStyle = '#333'; ctx.lineWidth = 10; ctx.strokeRect(6,6,500,116);
    ctx.fillStyle = '#8b0000'; ctx.font = 'bold 78px Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('Christmas', 256, 64);

    const label = new THREE.Mesh(
      new THREE.PlaneGeometry(94, 30),
      new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true })
    );
    label.position.set(0, -125, 82);
    globe.add(label);

    // ==================== CẢNH BÊN TRONG ====================
    const inside = new THREE.Group();
    globe.add(inside);

    // Đất tuyết
    const ground = new THREE.Mesh(
      new THREE.CircleGeometry(112, 64),
      new THREE.MeshStandardMaterial({ color: 0xf5faff, roughness: 0.9 })
    );
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -80;
    inside.add(ground);

    // Nhà gỗ
    const house = new THREE.Group();
    const walls = new THREE.Mesh(new THREE.BoxGeometry(52, 48, 52), new THREE.MeshStandardMaterial({color:0x8b4513}));
    const roof = new THREE.Mesh(new THREE.ConeGeometry(64, 42, 4), new THREE.MeshStandardMaterial({color:0xb22222}));
    roof.position.y = 45; roof.rotation.y = Math.PI/4;
    const door = new THREE.Mesh(new THREE.BoxGeometry(12, 24, 2), new THREE.MeshStandardMaterial({color:0x654321}));
    door.position.set(0, -12, 26.1);
    house.add(walls, roof, door);
    house.position.set(-18, -56, -18);
    inside.add(house);

    // Người tuyết dễ thương
    const snowman = new THREE.Group();
    const body1 = new THREE.Mesh(new THREE.SphereGeometry(17), new THREE.MeshStandardMaterial({color:0xffffff}));
    const body2 = new THREE.Mesh(new THREE.SphereGeometry(13), new THREE.MeshStandardMaterial({color:0xffffff}));
    body2.position.y = 23;
    const head = new THREE.Mesh(new THREE.SphereGeometry(10), new THREE.MeshStandardMaterial({color:0xffffff}));
    head.position.y = 40;

    // Mắt mũ cao bồi
    const hat = new THREE.Mesh(new THREE.CylinderGeometry(8, 10, 20), new THREE.MeshStandardMaterial({color:0x000000}));
    hat.position.y = 48;
    const hatTop = new THREE.Mesh(new THREE.CylinderGeometry(12, 12, 4), new THREE.MeshStandardMaterial({color:0x000000}));
    hatTop.position.y = 60;
    // Khăn quàng đỏ
    const scarf = new THREE.Mesh(new THREE.BoxGeometry(24, 5, 12), new THREE.MeshStandardMaterial({color:0xff0000}));
    scarf.position.set(0, 32, 10);

    snowman.add(body1, body2, head, hat, hatTop, scarf);
    snowman.position.set(38, -63, 8);
    inside.add(snowman);

    // 4 cây thông ngẫu nhiên
    for(let i=0; i<4; i++){
      const tree = new THREE.Group();
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(5,7,22), new THREE.MeshStandardMaterial({color:0x654321}));
      const leaves = new THREE.Mesh(new THREE.ConeGeometry(28,55,10), new THREE.MeshStandardMaterial({color:0x0f5132}));
      leaves.position.y = 38;
      tree.add(trunk, leaves);
      tree.position.set(-65 + i*45, -65, -35 - Math.random()*25);
      tree.scale.setScalar(0.6 + Math.random()*0.6);
      tree.rotation.y = Math.random()*Math.PI;
      inside.add(tree);
    }

    // ==================== TUYẾT RƠI ====================
    const snowCount = 5000;
    const snowGeo = new THREE.BufferGeometry();
    const positions = new Float32Array(snowCount * 3);
    for(let i=0; i<snowCount*3; i+=3){
      positions[i]   = THREE.MathUtils.randFloatSpread(240);
      positions[i+1] = THREE.MathUtils.randFloatSpread(300) + 100;
      positions[i+2] = THREE.MathUtils.randFloatSpread(240);
    }
    snowGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));

    const snow = new THREE.Points(
      snowGeo,
      new THREE.PointsMaterial({
        color: 0xffffff,
        size: 4.5,
        transparent: true,
        opacity: 0.9,
        blending: THREE.AdditiveBlending
      })
    );
    globe.add(snow);

    // Ánh sáng
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
    sunLight.position.set(100, 200, 100);
    scene.add(sunLight);

    // ==================== CHỈ LẮC KHI BẤM VÀO QUẢ CẦU ====================
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let shake = 0;

    function onPointer(event) {
      const clientX = event.touches ? event.touches[0].clientX : event.clientX;
      const clientY = event.touches ? event.touches[0].clientY : event.clientY;

      mouse.x = (clientX / innerWidth) * 2 - 1;
      mouse.y = -(clientY / innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(glass);

      if (intersects.length > 0) {
        shake = 1;
        snow.material.size = 8;
        setTimeout(() => snow.material.size = 4.5, 1200);
      }
    }

    window.addEventListener('click', onPointer);
    window.addEventListener('touchstart', onPointer);

    // ==================== ANIMATION ====================
    function animate() {
      requestAnimationFrame(animate);

      // Quay chậm liên tục
      globe.rotation.y += 0.004;

      // Hiệu ứng lắc
      if (shake > 0.01) {
        globe.rotation.y += Math.sin(performance.now() * 0.03) * 0.05 * shake;
        globe.rotation.x += Math.sin(performance.now() * 0.022) * 0.04 * shake;
        shake *= 0.93;
      }

      // Tuyết rơi + rơi mạnh khi lắc
      const pos = snow.geometry.attributes.position.array;
      for (let i = 1; i < pos.length; i += 3) {
        pos[i] -= 0.7 + shake * 4;
        if (pos[i] < -180) pos[i] += 450;
      }
      snow.geometry.attributes.position.needsUpdate = true;

      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
