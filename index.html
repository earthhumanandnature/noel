<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Quả Cầu Tuyết Giáng Sinh 2025</title>
  <link rel="icon" href="data:,">
  <style>
    body { margin:0; overflow:hidden; background:#000; touch-action:none; }
    #info { position:absolute; top:20px; left:50%; transform:translateX(-50%); color:#fff; background:rgba(0,0,0,0.7); padding:12px 40px; border-radius:40px; font-size:18px; pointer-events:none; z-index:100; transition:opacity 1s; }
    #finalImage { position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; z-index:998; opacity:0; transition:opacity 2s; }
    #finalImage img { width:100vw; height:100vh; object-fit:cover; }
    #merry { position:fixed; inset:0; color:#ff3366; font-size:90px; font-weight:bold; display:flex; align-items:center; justify-content:center; flex-direction:column; opacity:0; pointer-events:none; z-index:999; text-shadow:0 0 80px #ff0066; transition:opacity 3s; text-align:center; padding:20px; }
    #merry span { font-size:64px; color:#00ffff; margin-top:30px; text-shadow:0 0 60px cyan; }
    #merry.active { opacity:1; animation: glow 2.5s infinite alternate; }
    @keyframes glow { from { text-shadow:0 0 80px #ff0066; } to { text-shadow:0 0 160px #ff6699; } }
  </style>
</head>
<body>
  <div id="info">Chạm vào quả cầu <span id="count">0</span>/3 lần...</div>
  <div id="finalImage"><img src="image.jpg" alt="Giáng sinh"></div>
  <div id="merry">MERRY CHRISTMAS 2025!<br><span>Chúc bạn một năm mới thật hạnh phúc!</span></div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000814);

    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 2000);
    camera.position.z = 380;

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;

    const globe = new THREE.Group();
    scene.add(globe);

    // Kính bắt click
    const glass = new THREE.Mesh(
      new THREE.SphereGeometry(120,64,64),
      new THREE.MeshStandardMaterial({color:0xffffff, metalness:0.1, roughness:0, transparent:true, opacity:0.22})
    );
    globe.add(glass);

    // (Tất cả phần đế, nhà, người tuyết, cây thông... giữ nguyên như bản trước)
    const base = new THREE.Mesh(new THREE.CylinderGeometry(84,94,64,64), new THREE.MeshStandardMaterial({color:0x8b4513}));
    base.position.y = -150; globe.add(base);
    const ribbon = new THREE.Mesh(new THREE.RingGeometry(82,94,64), new THREE.MeshStandardMaterial({color:0xc41e3a, side:THREE.DoubleSide}));
    ribbon.rotation.x = -Math.PI/2; ribbon.position.y = -125; globe.add(ribbon);

    const canvas = document.createElement('canvas'); canvas.width=512; canvas.height=128;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffd700'; ctx.fillRect(0,0,512,128);
    ctx.strokeStyle = '#333'; ctx.lineWidth = 10; ctx.strokeRect(8,8,496,112);
    ctx.fillStyle = '#8b0000'; ctx.font = 'bold 80px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('Christmas',256,64);
    const label = new THREE.Mesh(new THREE.PlaneGeometry(96,32), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(canvas), transparent:true}));
    label.position.set(0,-125,83); globe.add(label);

    const inside = new THREE.Group(); globe.add(inside);
    const ground = new THREE.Mesh(new THREE.CircleGeometry(114,64), new THREE.MeshStandardMaterial({color:0xf8faff}));
    ground.rotation.x = -Math.PI/2; ground.position.y = -80; inside.add(ground);

    const house = new THREE.Group();
    house.add(new THREE.Mesh(new THREE.BoxGeometry(54,50,54), new THREE.MeshStandardMaterial({color:0x8b4513})));
    const roof = new THREE.Mesh(new THREE.ConeGeometry(66,44,4), new THREE.MeshStandardMaterial({color:0xb22222}));
    roof.position.y = 47; roof.rotation.y = Math.PI/4; house.add(roof);
    house.position.set(-20,-55,-15); inside.add(house);

    const snowman = new THREE.Group();
    snowman.add(new THREE.Mesh(new THREE.SphereGeometry(18), new THREE.MeshStandardMaterial({color:0xffffff})));
    const mid = new THREE.Mesh(new THREE.SphereGeometry(14), new THREE.MeshStandardMaterial({color:0xffffff})); mid.position.y = 25; snowman.add(mid);
    const head = new THREE.Mesh(new THREE.SphereGeometry(10), new THREE.MeshStandardMaterial({color:0xffffff})); head.position.y = 43; snowman.add(head);
    const hat = new THREE.Mesh(new THREE.CylinderGeometry(9,11,22), new THREE.MeshStandardMaterial({color:0x000})); hat.position.y = 52; snowman.add(hat);
    const scarf = new THREE.Mesh(new THREE.BoxGeometry(26,6,14), new THREE.MeshStandardMaterial({color:0xff0000})); scarf.position.set(0,34,11); snowman.add(scarf);
    snowman.position.set(40,-62,10); inside.add(snowman);

    for(let i=0; i<4; i++){
      const tree = new THREE.Group();
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(5,7,24), new THREE.MeshStandardMaterial({color:0x654321}));
      const leaves = new THREE.Mesh(new THREE.ConeGeometry(30,60,12), new THREE.MeshStandardMaterial({color:0x0f5132}));
      leaves.position.y = 42;
      tree.add(trunk); tree.add(leaves);
      tree.position.set(-70 + i*50, -64, -40 - Math.random()*30);
      tree.scale.setScalar(0.6 + Math.random()*0.5);
      tree.rotation.y = Math.random() * Math.PI;
      inside.add(tree);
    }

    const snowCount = 7000;
    const posArray = new Float32Array(snowCount*3);
    for(let i=0; i<snowCount*3; i+=3){
      posArray[i]   = THREE.MathUtils.randFloatSpread(250);
      posArray[i+1] = 200 + Math.random()*100;
      posArray[i+2] = THREE.MathUtils.randFloatSpread(250);
    }
    const snow = new THREE.Points(
      new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(posArray,3)),
      new THREE.PointsMaterial({color:0xffffff,size:5.5,transparent:true,opacity:0.92,blending:THREE.AdditiveBlending})
    );
    globe.add(snow);

    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.8);
    dirLight.position.set(120, 250, 100);
    scene.add(dirLight);

    // ==================== HỘP QUÀ 3D X1.5 – LẮC THẬT MẠNH + NẮP BAY TỪ TỪ ====================
    const giftGroup = new THREE.Group();
    giftGroup.position.set(0, -100, 0);
    giftGroup.scale.set(0.01, 0.01, 0.01);
    scene.add(giftGroup);

    const giftBody = new THREE.Mesh(
      new THREE.BoxGeometry(120, 120, 120),
      new THREE.MeshPhysicalMaterial({color:0xff1122, metalness:0.4, roughness:0.2, clearcoat:1})
    );
    const ribbonV = new THREE.Mesh(new THREE.BoxGeometry(18, 135, 135), new THREE.MeshPhysicalMaterial({color:0xffee00}));
    const ribbonH = new THREE.Mesh(new THREE.BoxGeometry(135, 135, 18), new THREE.MeshPhysicalMaterial({color:0xffee00}));
    const bow = new THREE.Mesh(new THREE.TorusGeometry(32, 10, 16, 100), new THREE.MeshPhysicalMaterial({color:0xffee00}));
    bow.rotation.x = Math.PI/2;

    giftGroup.add(giftBody, ribbonV, ribbonH, bow);

    const giftLid = new THREE.Mesh(
      new THREE.BoxGeometry(124, 30, 124),
      new THREE.MeshPhysicalMaterial({color:0xee0000, metalness:0.5, roughness:0.2})
    );
    giftLid.position.y = 75;
    giftGroup.add(giftLid);

    const giftLight = new THREE.PointLight(0xffaa00, 0, 400);
    giftLight.position.set(0, 0, 0);
    giftGroup.add(giftLight);

    let clickCount = 0, spinSpeed = 0, shake = 0, isExploded = false, giftClicks = 0;
    const countDisplay = document.getElementById('count');
    const fragments = [];
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function onPointer(e){
      if(isExploded) return;
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      mouse.x = (x/innerWidth)*2 - 1;
      mouse.y = -(y/innerHeight)*2 + 1;
      raycaster.setFromCamera(mouse, camera);

      if(raycaster.intersectObject(glass).length > 0){
        shake = 1;
        snow.material.size = 10;
        setTimeout(()=>snow.material.size = 5.5, 800);
        clickCount++;
        countDisplay.textContent = clickCount;

        if(clickCount === 3){
          let crazy = 0;
          const spinInt = setInterval(() => {
            crazy += 0.5;
            spinSpeed = crazy;
            if(crazy > 22){
              clearInterval(spinInt);
              setTimeout(explodeGlobe, 800);
            }
          }, 70);
        }
      }
    }
    window.addEventListener('click', onPointer);
    window.addEventListener('touchstart', onPointer);

    function explodeGlobe(){
      isExploded = true;
      document.getElementById('info').style.opacity = 0;

      for(let i=0; i<320; i++){
        const f = new THREE.Mesh(new THREE.PlaneGeometry(10+Math.random()*22,10+Math.random()*22),
          new THREE.MeshPhysicalMaterial({color:0xffffff,metalness:0.95,roughness:0.05,transmission:0.98,thickness:10,transparent:true,opacity:0.9})
        );
        f.position.copy(glass.position);
        const dir = new THREE.Vector3(Math.random()-0.5,Math.random()-0.2,Math.random()-0.5).normalize().multiplyScalar(15+Math.random()*30);
        f.userData = {vel:dir, rot:new THREE.Vector3(Math.random()*60,Math.random()*60,Math.random()*60)};
        scene.add(f); fragments.push(f);
      }
      globe.visible = false;

      setTimeout(() => {
        const img = document.getElementById('finalImage');
        img.style.display = 'flex';
        setTimeout(() => img.style.opacity = 1, 100);
        new Audio('music.mp3').play().catch(()=>{});
      }, 1800);

      setTimeout(() => {
        document.getElementById('finalImage').style.opacity = 0;
        setTimeout(() => {
          document.getElementById('finalImage').style.display = 'none';
          giftGroup.scale.set(1.5, 1.5, 1.5);
        }, 2000);
      }, 1800 + 3500);
    }

    // LẮC HỘP QUÀ THẬT MẠNH (giống lắc quà thật)
    function shakeGift() {
      const intensity = 0.3;
      let time = 0;
      const shakeInterval = setInterval(() => {
        time += 0.15;
        giftGroup.rotation.x = Math.sin(time * 10) * intensity;
        giftGroup.rotation.z = Math.cos(time * 12) * intensity;
        giftGroup.position.x = Math.sin(time * 8) * 15;
        giftGroup.position.y = -100 + Math.abs(Math.sin(time * 15)) * 20;
        if (time > 4) {
          clearInterval(shakeInterval);
          giftGroup.rotation.set(0, giftGroup.rotation.y, 0);
          giftGroup.position.set(0, -100, 0);
        }
      }, 16);
    }

    renderer.domElement.addEventListener('click', (e) => {
      if(giftClicks >= 3 || giftGroup.scale.x < 1) return;
      mouse.x = (e.clientX / innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      if(raycaster.intersectObject(giftBody).length > 0 || raycaster.intersectObject(giftLid).length > 0){
        giftClicks++;
        giftLight.intensity = giftClicks * 7;
        shakeGift(); // ← LẮC THẬT ĐÃ
        if(giftClicks === 3) setTimeout(openGift, 1400);
      }
    });

    // NẮP BAY TỪ TỪ + XOAY ĐẸP
    function openGift(){
      new Audio('music2.mp3').play().catch(()=>{});
      giftLight.intensity = 50;

      // Bay lên từ từ 3 giây + xoay chậm
      let progress = 0;
      const flyUp = setInterval(() => {
        progress += 0.015;
        giftLid.position.y = 75 + progress * 400;
        giftLid.rotation.x += 0.02;
        giftLid.rotation.z += 0.015;
        if (progress >= 1) {
          clearInterval(flyUp);
          setTimeout(() => {
            giftGroup.visible = false;
            document.getElementById('merry').classList.add('active');
          }, 800);
        }
      }, 16);
    }

    function animate(){
      requestAnimationFrame(animate);
      globe.rotation.y += 0.004 + spinSpeed;
      giftGroup.rotation.y += 0.006;

      if(shake > 0.01){
        globe.rotation.y += Math.sin(performance.now()*0.03)*0.06*shake;
        globe.rotation.x += Math.sin(performance.now()*0.022)*0.05*shake;
        shake *= 0.92;
      }

      const pos = snow.geometry.attributes.position.array;
      for(let i=1; i<pos.length; i+=3){
        pos[i] -= 1 + spinSpeed*8 + shake*6;
        if(pos[i] < -200) pos[i] += 500;
      }
      snow.geometry.attributes.position.needsUpdate = true;

      fragments.forEach(f => {
        f.position.add(f.userData.vel);
        f.rotation.x += f.userData.rot.x * 0.04;
        f.rotation.y += f.userData.rot.y * 0.04;
        f.rotation.z += f.userData.rot.z * 0.04;
        f.userData.vel.y -= 0.6;
        f.material.opacity *= 0.98;
        if(f.material.opacity < 0.02) scene.remove(f);
      });

      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
