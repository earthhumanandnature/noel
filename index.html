<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Quả Cầu Tuyết Giáng Sinh 3D</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    .info {
      position: absolute; top: 15px; left: 15px; color: #fff; background: rgba(0,0,0,0.6);
      padding: 15px 20px; border-radius: 12px; font-size: 16px; pointer-events: none; z-index: 10;
    }
  </style>
</head>
<body>

<div class="info">
  Giữ chuột trái + kéo để xoay quả cầu<br>
  <strong>Chúc mừng Giáng Sinh ấm áp!</strong>
</div>

<!-- DÙNG CDN MỚI NHẤT + ĐƯỜNG DẪN ĐÚNG 2025 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/loaders/GLTFLoader.js"></script>

<script type="module">
  // ==== BẮT BUỘC PHẢI DÙNG type="module" KHI DÙNG jsm (đường dẫn mới) ====
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/loaders/GLTFLoader.js';

  // === CẤU HÌNH CƠ BẢN ===
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0d1b2a);
  scene.fog = new THREE.FogExp2(0x0d1b2a, 0.0018);

  const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 8, 22);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.07;
  controls.enablePan = false;
  controls.minDistance = 15;
  controls.maxDistance = 45;

  // Ánh sáng
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  scene.add(new THREE.DirectionalLight(0xffffff, 1.2)).position.set(15, 25, 10);
  scene.add(new THREE.HemisphereLight(0x87CEEB, 0x3b1e40, 0.9));

  const globeGroup = new THREE.Group();
  scene.add(globeGroup);

  // === NỀN TUYẾT + NHÀ + CÂY THÔNG ===
  const ground = new THREE.Mesh(
    new THREE.CircleGeometry(100, 64),
    new THREE.MeshStandardMaterial({ color: 0xf8f9ff, roughness: 0.95 })
  );
  ground.rotation.x = -Math.PI / 2;
  scene.add(ground);

  // (giữ nguyên các hàm tạo nhà, cây thông như bản trước - mình rút gọn để dễ đọc)
  // Nhà
  const houseGeo = new THREE.BoxGeometry(5,5,5);
  const roofGeo = new THREE.ConeGeometry(6,3.5,4);
  [-18,20,-15].forEach((x,i) => {
    const house = new THREE.Group();
    const body = new THREE.Mesh(houseGeo, new THREE.MeshStandardMaterial({color:0xd32f2f}));
    body.position.y = 2.5;
    const roof = new THREE.Mesh(roofGeo, new THREE.MeshStandardMaterial({color:0xffffff}));
    roof.position.y = 7; roof.rotation.y = Math.PI/4;
    house.add(body,roof);
    house.position.set(x,0,[-22,-15,12][i]);
    scene.add(house);
  });

  // === QUẢ CẦU PHA LÊ + GIÁ ĐỠ VÀNG ===
  const glass = new THREE.Mesh(
    new THREE.SphereGeometry(8,64,64),
    new THREE.MeshPhysicalMaterial({
      transmission: 0.98, roughness: 0, metalness: 0, thickness: 1.8, clearcoat: 1
    })
  );
  globeGroup.add(glass);

  const gold = new THREE.MeshStandardMaterial({color:0xffd700, metalness:0.95, roughness:0.15});
  globeGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(9.2,10,2,64), gold)).position.y = -9.5;
  globeGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(4.5,5.5,4,64), gold)).position.y = -12;

  // === CÂY THÔNG + QUÀ + TUYẾT ===
  new GLTFLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/ChristmasTree/ChristmasTree.gltf', gltf => {
    const tree = gltf.scene;
    tree.scale.set(3.2,3.2,3.2);
    tree.position.y = -6;
    globeGroup.add(tree);
    window.tree = tree; // để xoay
  });

  // 10 hộp quà
  for(let i=0; i<10; i++){
    const angle = i/10*Math.PI*2;
    const r = 2.5 + Math.random()*2.5;
    const gift = new THREE.Group();
    gift.add(new THREE.Mesh(new THREE.BoxGeometry(1.6,1.6,1.6), new THREE.MeshStandardMaterial({color:Math.random()>0.5?0xff0033:0x00aa33})));
    const ribbon = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.25,0.25), new THREE.MeshStandardMaterial({color:0xffff66}));
    gift.add(ribbon);
    gift.add(ribbon.clone().rotateY(Math.PI/2));
    gift.position.set(Math.cos(angle)*r, -7.1, Math.sin(angle)*r);
    globeGroup.add(gift);
  }

  // Tuyết trong quả cầu
  const snowflakes = [];
  for(let i=0; i<450; i++){
    const s = new THREE.Mesh(new THREE.SphereGeometry(0.09,8,8), new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.9}));
    s.position.set((Math.random()-0.5)*15, Math.random()*25-5, (Math.random()-0.5)*15);
    globeGroup.add(s);
    snowflakes.push(s);
  }

  // Tuyết ngoài trời
  const outside = [];
  for(let i=0; i<350; i++){
    const s = new THREE.Mesh(new THREE.SphereGeometry(0.09,8,8), new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.8}));
    s.position.set((Math.random()-0.5)*250, Math.random()*60+10, (Math.random()-0.5)*250);
    scene.add(s);
    outside.push(s);
  }

  // === ANIMATION ===
  function anim() {
    requestAnimationFrame(anim);
    controls.update();

    // tuyết trong
    snowflakes.forEach(s=>{
      s.position.y -= 0.03;
      s.position.x += Math.sin(Date.now()*0.001 + s.position.z)*0.02;
      if(s.position.y < -15) s.position.y = 12;
    });
    // tuyết ngoài
    outside.forEach(s=>{ s.position.y -= 0.03; if(s.position.y < -5) s.position.y = 60; });

    if(window.tree) window.tree.rotation.y += 0.003;

    renderer.render(scene, camera);
  }
  anim();

  // Resize
  window.onresize = () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  };
</script>
</body>
</html>
