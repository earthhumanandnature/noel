<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Quả Cầu Tuyết Giáng Sinh 3D - Đẹp Lung Linh!</title>
  <style>
    body { margin:0; overflow:hidden; background:#0b1320; }
    .info {
      position: absolute; top: 15px; left: 15px; color: #fff; background: rgba(0,0,0,0.6);
      padding: 15px 22px; border-radius: 12px; font-size: 16px; pointer-events: none; z-index: 10;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>

<div class="info">
  Giữ chuột trái + kéo để xoay quả cầu<br>
  <strong>Chúc bạn Giáng Sinh thật hạnh phúc!</strong>
</div>

<!-- Dùng r128 + đường dẫn cũ để chạy local 100% -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// ============== CƠ BẢN ==============
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a1a3d);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 8, 28);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.enablePan = false;
controls.minDistance = 20;
controls.maxDistance = 60;

// ============== ÁNH SÁNG MẠNH ĐỂ QUA KÍNH ==============
scene.add(new THREE.AmbientLight(0xffffff, 0.9));
const sun = new THREE.DirectionalLight(0xffffff, 1.8);
sun.position.set(20, 40, 20);
scene.add(sun);
scene.add(new THREE.HemisphereLight(0xb3e5fc, 0x442255, 1.2));

// ============== NỀN TUYẾT (đã hạ thấp xuống) ==============
const ground = new THREE.Mesh(
  new THREE.CircleGeometry(150, 64),
  new THREE.MeshStandardMaterial({ color: 0xf0f4ff, roughness: 0.95 })
);
ground.rotation.x = -Math.PI / 2;
ground.position.y = -10;          // ĐÃ HẠ THẤP XUỐNG
scene.add(ground);

// ============== QUẢ CẦU KÍNH TRONG SUỐT (r128) ==============
const globeGroup = new THREE.Group();
scene.add(globeGroup);

// Kính trong suốt (cách cũ nhưng cực đẹp với r128)
const glass = new THREE.Mesh(
  new THREE.SphereGeometry(9, 64, 64),
  new THREE.MeshPhongMaterial({
    color: 0xffffff,
    transparent: true,
    opacity: 0.25,
    shininess: 100,
    specular: 0xffffff,
    reflectivity: 1,
    side: THREE.DoubleSide
  })
);
globeGroup.add(glass);

// Đáy trong suốt (để thấy tuyết rơi bên trong)
const innerFloor = new THREE.Mesh(
  new THREE.CircleGeometry(8.5, 64),
  new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.2 })
);
innerFloor.rotation.x = -Math.PI/2;
innerFloor.position.y = -8.9;
globeGroup.add(innerFloor);

// ============== GIÁ ĐỠ VÀNG ==============
const gold = new THREE.MeshPhongMaterial({ color: 0xffd700, shininess: 90, specular: 0xffffff });
const base = new THREE.Mesh(new THREE.CylinderGeometry(10, 11, 2.5, 64), gold);
base.position.y = -11.5;
globeGroup.add(base);
const stand = new THREE.Mesh(new THREE.CylinderGeometry(5, 6, 5, 64), gold);
stand.position.y = -15;
globeGroup.add(stand);

// ============== CÂY THÔNG + QUÀ + TUYẾT BÊN TRONG ==============
let tree;
new THREE.GLTFLoader().load(
  'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/ChristmasTree/ChristmasTree.gltf',
  gltf => {
    tree = gltf.scene;
    tree.scale.set(3.8, 3.8, 3.8);
    tree.position.y = -8;
    globeGroup.add(tree);
  }
);

// 12 hộp quà
for(let i=0; i<12; i++){
  const angle = i/12*Math.PI*2;
  const r = 2.5 + Math.random()*3;
  const g = new THREE.Group();
  g.add(new THREE.Mesh(new THREE.BoxGeometry(1.6,1.6,1.6),
    new THREE.MeshPhongMaterial({color: Math.random()>0.5?0xff0033:0x00aa00})));
  const rib = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.2,0.2),
    new THREE.MeshPhongMaterial({color:0xffff66}));
  rib.position.y=0.8;
  g.add(rib);
  g.add(rib.clone().rotateY(Math.PI/2));
  g.position.set(Math.cos(angle)*r, -8.8, Math.sin(angle)*r);
  globeGroup.add(g);
}

// Tuyết rơi bên trong
const snowIn = [];
for(let i=0; i<600; i++){
  const s = new THREE.Mesh(
    new THREE.SphereGeometry(0.08,6,6),
    new THREE.MeshBasicMaterial({color:0xffffff})
  );
  s.position.set(
    (Math.random()-0.5)*16,
    Math.random()*25-5,
    (Math.random()-0.5)*16
  );
  globeGroup.add(s);
  snowIn.push(s);
}

// Tuyết rơi ngoài trời
for(let i=0; i<500; i++){
  const s = new THREE.Mesh(
    new THREE.SphereGeometry(0.1,6,6),
    new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.7})
  );
  s.position.set(
    (Math.random()-0.5)*400,
    Math.random()*100+20,
    (Math.random()-0.5)*400
  );
  scene.add(s);
  snowIn.push(s);   // dùng chung mảng để animate luôn
}

// ============== ANIMATION ==============
function animate(){
  requestAnimationFrame(animate);
  controls.update();

  // Tuyết rơi
  snowIn.forEach(s=>{
    s.position.y -= 0.04 + Math.random()*0.04;
    s.position.x += Math.sin(Date.now()*0.001 + s.position.z)*0.02;
    if(s.position.y < -20) s.position.y = 30;
  });

  if(tree) tree.rotation.y += 0.004;

  renderer.render(scene, camera);
}
animate();

// Resize
window.addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
