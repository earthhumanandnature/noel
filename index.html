<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Quả Cầu Tuyết Christmas 2025</title>
  <style>
    body { margin:0; overflow:hidden; background:#0a1a3a; touch-action:none; }
    #info { position:absolute; top:20px; left:50%; transform:translateX(-50%);
            color:#fff; font-family:Arial; font-size:16px; background:rgba(0,0,0,0.5);
            padding:10px 20px; border-radius:20px; pointer-events:none; z-index:10; }
  </style>
</head>
<body>
  <div id="info">Chạm hoặc lắc nhẹ quả cầu tuyết nhé!</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // ---------- CƠ BẢN ----------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a1a3a);

    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 350);

    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.enableZoom = true;
    controls.enablePan = false;
    controls.minDistance = 200;
    controls.maxDistance = 500;

    // ---------- QUẢ CẦU KÍNH ----------
    const globe = new THREE.Group();
    scene.add(globe);

    // Kính trong suốt + phản chiếu
    const glass = new THREE.Mesh(
      new THREE.SphereGeometry(120, 64, 64),
      new THREE.MeshPhysicalMaterial({
        color: 0xffffff,
        metalness: 0.1,
        roughness: 0,
        transmission: 0.98,
        thickness: 15,
        clearcoat: 1,
        clearcoatRoughness: 0,
        transparent: true,
        opacity: 0.95
      })
    );
    globe.add(glass);

    // Đế gỗ
    const base = new THREE.Mesh(
      new THREE.CylinderGeometry(80, 90, 60, 64),
      new THREE.MeshStandardMaterial({color:0x8b4513})
    );
    base.position.y = -150;
    globe.add(base);

    // Băng rôn đỏ + chữ Christmas
    const ribbon = new THREE.Mesh(
      new THREE.CylinderGeometry(85, 85, 15, 64, 1, false, 0, Math.PI*2),
      new THREE.MeshStandardMaterial({color:0xc41e3a})
    );
    ribbon.position.y = -125;
    globe.add(ribbon);

    const label = new THREE.Mesh(
      new THREE.PlaneGeometry(80, 25),
      new THREE.MeshBasicMaterial({
        map: new THREE.CanvasTexture(createLabel("Christmas")),
        transparent: true
      })
    );
    label.position.y = -125;
    label.rotation.x = -Math.PI/2;
    globe.add(label);

    function createLabel(text) {
      const canvas = document.createElement('canvas');
      canvas.width = 512; canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#d4af37';
      ctx.fillRect(0,0,512,128);
      ctx.fillStyle = '#8b4513';
      ctx.roundRect(20,20,472,88,20).fill();
      ctx.fillStyle = '#ffd700';
      ctx.font = 'bold 56px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, 256, 64);
      return canvas;
    }

    // ---------- CẢNH BÊN TRONG ----------
    const inside = new THREE.Group();
    globe.add(inside);

    // Đất tuyết
    const ground = new THREE.Mesh(
      new THREE.CircleGeometry(110, 64),
      new THREE.MeshStandardMaterial({color:0xf0f8ff, roughness:0.8})
    );
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -80;
    inside.add(ground);

    // Nhà gỗ
    const house = new THREE.Group();
    const walls = new THREE.Mesh(new THREE.BoxGeometry(50,40,50), new THREE.MeshStandardMaterial({color:0x8b4513}));
    const roof = new THREE.Mesh(new THREE.ConeGeometry(60,40,4), new THREE.MeshStandardMaterial({color:0xdc143c}));
    roof.position.y = 40;
    roof.rotation.y = Math.PI/4;
    house.add(walls, roof);
    house.position.set(-20, -60, -20);
    inside.add(house);

    // Người tuyết
    const snowman = new THREE.Group();
    const body1 = new THREE.Mesh(new THREE.SphereGeometry(15,32,32), new THREE.MeshStandardMaterial({color:0xffffff}));
    const body2 = new THREE.Mesh(new THREE.SphereGeometry(11,32,32), new THREE.MeshStandardMaterial({color:0xffffff}));
    body2.position.y = 20;
    const head = new THREE.Mesh(new THREE.SphereGeometry(8,32,32), new THREE.MeshStandardMaterial({color:0xffffff}));
    head.position.y = 35;
    const hat = new THREE.Mesh(new THREE.CylinderGeometry(6,8,15,32), new THREE.MeshStandardMaterial({color:0x111111}));
    hat.position.y = 43;
    snowman.add(body1,body2,head,hat);
    snowman.position.set(30, -65, 10);
    inside.add(snowman);

    // Cây thông (3 cây)
    for(let i=0;i<3;i++){
      const tree = new THREE.Group();
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(5,8,25,16), new THREE.MeshStandardMaterial({color:0x8b4513}));
      const leaves = new THREE.Mesh(new THREE.ConeGeometry(30,60,16), new THREE.MeshStandardMaterial({color:0x0f5132}));
      leaves.position.y = 40;
      tree.add(trunk,leaves);
      tree.position.set(-40+40*i, -60, -40-Math.random()*20);
      tree.scale.set(0.7+Math.random()*0.4,0.7+Math.random()*0.4,0.7+Math.random()*0.4);
      inside.add(tree);
    }

    // ---------- TUYẾT RƠI ----------
    const snowParticles = [];
    const snowGeo = new THREE.BufferGeometry();
    const snowCount = 3000;
    const posArray = new Float32Array(snowCount * 3);

    for(let i=0; i<snowCount*3; i+=3){
      posArray[i]   = THREE.MathUtils.randFloatSpread(300);
      posArray[i+1] = THREE.MathUtils.randFloatSpread(200) + 100;
      posArray[i+2] = THREE.MathUtils.randFloatSpread(300);
    }
    snowGeo.setAttribute('position', new THREE.BufferAttribute(posArray,3));

    const snowMat = new THREE.PointsMaterial({
      color: 0xffffff,
      size: 3,
      transparent: true,
      opacity: 0.9,
      blending: THREE.AdditiveBlending
    });

    const snow = new THREE.Points(snowGeo, snowMat);
    globe.add(snow);

    // ---------- ÁNH SÁNG ----------
    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);
    const topLight = new THREE.DirectionalLight(0xffffff, 0.8);
    topLight.position.set(100,200,100);
    scene.add(topLight);

    // ---------- LẮC QUẢ CẦU ----------
    let shakeIntensity = 0;
    function shakeGlobe(){
      shakeIntensity = 1;
      // tăng tuyết rơi mạnh hơn khi lắc
      snowMat.size = 5;
      setTimeout(()=> snowMat.size = 3, 800);
    }

    // Chạm / click / lắc điện thoại
    window.addEventListener('click', shakeGlobe);
    window.addEventListener('touchstart', shakeGlobe);

    // Lắc điện thoại (nếu dùng trên mobile)
    if(window.DeviceMotionEvent){
      window.addEventListener('devicemotion', (e)=>{
        const acc = e.accelerationIncludingGravity;
        if(Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z) > 20){
          shakeGlobe();
        }
      });
    }

    // ---------- ANIMATION ----------
    function animate(){
      requestAnimationFrame(animate);

      // Quay nhẹ liên tục
      globe.rotation.y += 0.003;

      // Lắc khi được chạm
      if(shakeIntensity > 0){
        globe.rotation.y += Math.sin(performance.now()*0.02)*0.03*shakeIntensity;
        globe.rotation.x += Math.sin(performance.now()*0.015)*0.02*shakeIntensity;
        shakeIntensity *= 0.95;
      }

      // Tuyết rơi
      const positions = snow.geometry.attributes.position.array;
      for(let i=1; i<positions.length; i+=3){
        positions[i] -= 0.5 + shakeIntensity*2;
        if(positions[i] < -150) positions[i] = 200;
      }
      snow.geometry.attributes.position.needsUpdate = true;

      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
